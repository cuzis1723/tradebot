<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pangjibot Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root {
  --bg: #06090f; --surface: #0d1320; --card: #111a2b; --card2: #162033;
  --border: #1c2a42; --border2: #253552;
  --text: #e8edf5; --text2: #7a8ba8; --text3: #4a5a75;
  --blue: #3b82f6; --blue2: #2563eb; --blue-glow: rgba(59,130,246,0.25);
  --green: #10b981; --green2: #059669; --green-glow: rgba(16,185,129,0.2);
  --red: #ef4444; --red2: #dc2626; --red-glow: rgba(239,68,68,0.2);
  --yellow: #f59e0b; --amber: #fbbf24; --amber-glow: rgba(251,191,36,0.15);
  --purple: #a78bfa; --purple2: #8b5cf6; --purple-glow: rgba(167,139,250,0.2);
  --teal: #14b8a6; --teal2: #0d9488; --teal-glow: rgba(20,184,166,0.2);
  --pink: #f472b6; --coral: #fb7185;
  --radius: 14px; --radius-sm: 8px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 14px; }
body { background: var(--bg); color: var(--text); font-family: 'Inter', -apple-system, 'Segoe UI', sans-serif; line-height: 1.5; min-height: 100vh; }
.app { max-width: 960px; margin: 0 auto; padding: 16px 16px 40px; }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header { display: flex; align-items: center; justify-content: space-between; padding: 8px 0 20px; }
.logo { display: flex; align-items: center; gap: 10px; }
.logo h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; background: linear-gradient(135deg, var(--blue), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px var(--green-glow); animation: pulse-dot 2s ease-in-out infinite; }
.live-dot.off { background: var(--red); box-shadow: 0 0 8px var(--red-glow); }
@keyframes pulse-dot { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
.header-right { display: flex; align-items: center; gap: 8px; }
.uptime-badge { font-size: 11px; color: var(--teal); background: var(--teal-glow); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(20,184,166,0.2); }
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 600; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; transition: all 0.15s; }
.btn:hover { background: var(--card2); border-color: var(--border2); }
.btn-primary { background: linear-gradient(135deg, var(--blue), var(--purple2)); border-color: var(--purple2); color: #fff; }
.btn-primary:hover { opacity: 0.9; }

/* ‚îÄ‚îÄ Agent Card ‚îÄ‚îÄ */
.agent-section { background: linear-gradient(135deg, var(--card) 0%, #151d30 50%, var(--card2) 100%); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 14px; display: flex; align-items: center; gap: 24px; position: relative; overflow: hidden; }
.agent-section::before { content: ''; position: absolute; top: -40px; right: -40px; width: 120px; height: 120px; background: radial-gradient(circle, var(--purple-glow), transparent 70%); pointer-events: none; }
.agent-section::after { content: ''; position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: radial-gradient(circle, var(--teal-glow), transparent 70%); pointer-events: none; }
@media (max-width: 600px) { .agent-section { flex-direction: column; text-align: center; } }

/* ‚îÄ‚îÄ Pixel Character ‚îÄ‚îÄ */
.pixel-character { width: 128px; height: 128px; flex-shrink: 0; position: relative; z-index: 1; }
.pixel-character canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; }

/* Agent status text */
.agent-info { flex: 1; min-width: 0; position: relative; z-index: 1; }
.agent-status-line { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.agent-status-text { font-size: 15px; font-weight: 600; }
.agent-action { font-size: 13px; color: var(--text2); margin-bottom: 8px; line-height: 1.5; }
.agent-meta { display: flex; gap: 14px; flex-wrap: wrap; }
.agent-meta-item { font-size: 12px; }
.agent-meta-label { color: var(--text3); }
.agent-meta-val { color: var(--text); font-weight: 600; }
.regime-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
.regime-badge.bullish { background: var(--green-glow); color: var(--green); }
.regime-badge.bearish { background: var(--red-glow); color: var(--red); }
.regime-badge.neutral { background: rgba(122,139,168,0.15); color: var(--text2); }
.regime-badge.warming { background: var(--amber-glow); color: var(--amber); }
.regime-badge.volatile { background: var(--purple-glow); color: var(--purple); }

/* ‚îÄ‚îÄ Metric Cards ‚îÄ‚îÄ */
.metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
@media (max-width: 700px) { .metrics { grid-template-columns: repeat(2, 1fr); } }
.metric { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; position: relative; overflow: hidden; }
.metric::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
.metric:nth-child(1)::before { background: linear-gradient(90deg, var(--teal), var(--blue)); }
.metric:nth-child(2)::before { background: linear-gradient(90deg, var(--blue), var(--purple)); }
.metric:nth-child(3)::before { background: linear-gradient(90deg, var(--green), var(--teal)); }
.metric-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 4px; }
.metric-value { font-size: 22px; font-weight: 700; line-height: 1.2; }
.metric-value.green { color: var(--green); }
.metric-value.red { color: var(--red); }
.metric-sub { font-size: 11px; color: var(--text2); margin-top: 3px; }

/* ‚îÄ‚îÄ Chart Section ‚îÄ‚îÄ */
.chart-section { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 14px; }
.chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.chart-title { font-size: 13px; font-weight: 600; color: var(--text2); }
.chart-tabs { display: flex; gap: 8px; align-items: center; }
.chart-toggle-group { display: flex; gap: 0; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
.chart-tab { padding: 5px 14px; font-size: 11px; font-weight: 600; color: var(--text3); cursor: pointer; transition: all 0.15s; border: none; background: transparent; }
.chart-tab.active { background: linear-gradient(135deg, var(--blue), var(--purple2)); color: #fff; }
.chart-tab:hover:not(.active) { color: var(--text2); background: var(--surface); }
.chart-wrap { height: 240px; position: relative; }
@media (max-width: 600px) { .chart-wrap { height: 200px; } }

/* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
.section { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 14px; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.section-title { font-size: 13px; font-weight: 600; color: var(--text2); }
.section-badge { font-size: 11px; color: var(--text3); }

/* Position cards */
.pos-list { display: flex; flex-direction: column; gap: 8px; }
.pos-card { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); transition: border-color 0.15s; }
.pos-card:hover { border-color: var(--border2); }
.pos-left { display: flex; align-items: center; gap: 10px; }
.pos-symbol { font-weight: 700; font-size: 14px; }
.pos-side { font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
.pos-side.long { color: var(--green); background: var(--green-glow); }
.pos-side.short { color: var(--red); background: var(--red-glow); }
.pos-details { font-size: 11px; color: var(--text2); }
.pos-right { text-align: right; }
.pos-pnl { font-size: 15px; font-weight: 700; }
.pos-pnl.green { color: var(--green); }
.pos-pnl.red { color: var(--red); }
.pos-meta { font-size: 11px; color: var(--text3); }
.pos-empty { text-align: center; color: var(--text3); padding: 20px; font-size: 13px; }

/* Position candlestick charts */
.pos-charts-grid { display: flex; flex-direction: column; gap: 12px; }
.pos-chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; }
.pos-chart-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid var(--border); }
.pos-chart-symbol { font-weight: 700; font-size: 13px; }
.pos-chart-price { font-size: 12px; color: var(--text2); }
.pos-chart-container { height: 280px; }

/* Position section layout with pie chart */
.pos-layout { display: flex; gap: 16px; }
.pos-layout .pos-list { flex: 1; min-width: 0; }
.pos-chart-wrap { width: 180px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
@media (max-width: 600px) { .pos-layout { flex-direction: column; } .pos-chart-wrap { width: 100%; height: 160px; } }

/* ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ */
.timeline { max-height: 500px; overflow-y: auto; }
.timeline::-webkit-scrollbar { width: 4px; }
.timeline::-webkit-scrollbar-track { background: transparent; }
.timeline::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.tl-item { position: relative; padding: 12px 12px 12px 28px; margin-bottom: 4px; border-radius: var(--radius-sm); transition: background 0.15s; cursor: pointer; }
.tl-item:hover { background: var(--surface); }
.tl-dot { position: absolute; left: 8px; top: 16px; width: 8px; height: 8px; border-radius: 50%; }
.tl-dot.comprehensive { background: var(--purple); box-shadow: 0 0 6px var(--purple-glow); }
.tl-dot.urgent { background: var(--coral); box-shadow: 0 0 6px var(--red-glow); }
.tl-line { position: absolute; left: 11px; top: 28px; bottom: -4px; width: 2px; background: var(--border); }
.tl-item:last-child .tl-line { display: none; }
.tl-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
.tl-type { font-size: 11px; font-weight: 700; text-transform: uppercase; }
.tl-type.comprehensive { color: var(--purple); }
.tl-type.urgent { color: var(--coral); }
.tl-time { font-size: 11px; color: var(--text3); }
.tl-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 4px; }
.tl-meta-tag { font-size: 10px; color: var(--text2); padding: 1px 6px; background: var(--surface); border-radius: 3px; border: 1px solid var(--border); }
.tl-reasoning { font-size: 12px; color: var(--text2); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.tl-item.expanded .tl-reasoning { -webkit-line-clamp: unset; }
.tl-trade { display: inline-flex; align-items: center; gap: 4px; margin-top: 6px; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
.tl-trade.buy { background: var(--green-glow); color: var(--green); }
.tl-trade.sell { background: var(--red-glow); color: var(--red); }
.tl-empty { text-align: center; color: var(--text3); padding: 24px; font-size: 13px; }

/* ‚îÄ‚îÄ Trade Journal ‚îÄ‚îÄ */
.journal-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; margin-bottom: 8px; }
.journal-card.win { border-left: 3px solid var(--green); }
.journal-card.loss { border-left: 3px solid var(--red); }
.journal-card.open { border-left: 3px solid #3b82f6; }
.journal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.journal-symbol { font-weight: 700; font-size: 13px; }
.journal-strategy { font-size: 11px; color: var(--text2); background: var(--surface2); padding: 1px 6px; border-radius: 8px; }
.journal-pnl { font-weight: 700; }
.journal-pnl.pos { color: var(--green); }
.journal-pnl.neg { color: var(--red); }
.journal-detail { font-size: 12px; color: var(--text2); margin-top: 4px; }
.journal-rationale { font-size: 11px; color: var(--text2); margin-top: 4px; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.journal-filters { display: flex; gap: 6px; }

/* ‚îÄ‚îÄ Share Modal ‚îÄ‚îÄ */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 16px; }
.modal-overlay.show { display: flex; }
.modal { background: var(--card); border: 1px solid var(--border2); border-radius: var(--radius); max-width: 540px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.modal-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--border); }
.modal-title { font-size: 15px; font-weight: 700; }
.modal-close { background: none; border: none; color: var(--text2); font-size: 20px; cursor: pointer; padding: 4px; }
.modal-body { padding: 16px; }
.modal-preview { width: 100%; border-radius: var(--radius-sm); margin-bottom: 12px; border: 1px solid var(--border); }
.modal-actions { display: flex; gap: 8px; }
.modal-actions .btn { flex: 1; justify-content: center; }

/* ‚îÄ‚îÄ Share watermark ‚îÄ‚îÄ */
.share-watermark { display: none; padding: 10px 16px; text-align: center; font-size: 11px; color: var(--text3); border-top: 1px solid var(--border); background: linear-gradient(90deg, var(--purple-glow), transparent, var(--teal-glow)); }
</style>
</head>
<body>
<div class="app">
  <div id="shareCard">
    <header>
      <div class="logo">
        <span class="live-dot" id="liveDot"></span>
        <h1>pangjibot</h1>
      </div>
      <div class="header-right">
        <span class="uptime-badge" id="uptime">connecting...</span>
        <button class="btn btn-primary" onclick="openShare()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
          Share
        </button>
      </div>
    </header>

    <!-- Agent Card -->
    <div class="agent-section">
      <div class="pixel-character" id="pixelChar">
        <canvas id="charCanvas" width="64" height="64"></canvas>
      </div>
      <div class="agent-info">
        <div class="agent-status-line">
          <span class="agent-status-text" id="agentStatus">Waking up...</span>
          <span class="regime-badge warming" id="regimeBadge">starting</span>
        </div>
        <div class="agent-action" id="agentAction">Connecting to exchange and loading market data...</div>
        <div class="agent-meta">
          <div class="agent-meta-item"><span class="agent-meta-label">Direction </span><span class="agent-meta-val" id="metaDir">-</span></div>
          <div class="agent-meta-item"><span class="agent-meta-label">Confidence </span><span class="agent-meta-val" id="metaConf">-</span></div>
          <div class="agent-meta-item"><span class="agent-meta-label">Risk </span><span class="agent-meta-val" id="metaRisk">-</span></div>
          <div class="agent-meta-item"><span class="agent-meta-label">LLM </span><span class="agent-meta-val" id="metaLlm">-</span></div>
        </div>
      </div>
    </div>

    <!-- Metric Cards -->
    <div class="metrics">
      <div class="metric">
        <div class="metric-label">Account Value</div>
        <div class="metric-value" id="mBalance">-</div>
        <div class="metric-sub" id="mBalanceSub"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Unrealized PnL</div>
        <div class="metric-value" id="mUpnl">-</div>
        <div class="metric-sub" id="mUpnlSub"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Margin Used</div>
        <div class="metric-value" id="mMargin">-</div>
        <div class="metric-sub" id="mMarginSub"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Realized PnL</div>
        <div class="metric-value" id="mRpnl">-</div>
        <div class="metric-sub" id="mRpnlSub"></div>
      </div>
    </div>

    <div class="share-watermark" id="shareWatermark">pangjibot &mdash; AI Crypto Trading Bot</div>
  </div>

  <!-- Positions -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Open Positions</div>
      <span class="section-badge" id="posBadge">-</span>
    </div>
    <div class="pos-layout">
      <div class="pos-list" id="positions">
        <div class="pos-empty">No open positions</div>
      </div>
      <div class="pos-chart-wrap"><canvas id="pieChart"></canvas></div>
    </div>
  </div>

  <!-- Position Charts -->
  <div class="section" id="posChartsSection" style="display:none">
    <div class="section-header">
      <div class="section-title">Position Charts</div>
      <div class="chart-toggle-group" id="candleIntervalTabs">
        <button class="chart-tab" data-interval="15m">15m</button>
        <button class="chart-tab active" data-interval="1h">1H</button>
        <button class="chart-tab" data-interval="4h">4H</button>
      </div>
    </div>
    <div id="posCharts" class="pos-charts-grid"></div>
  </div>

  <!-- Trade Journal -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Trade Journal <span class="badge" id="journalBadge"></span></div>
      <div class="journal-filters">
        <div class="chart-toggle-group" id="journalStatusTabs">
          <button class="chart-tab active" data-status="all">All</button>
          <button class="chart-tab" data-status="open">Open</button>
          <button class="chart-tab" data-status="closed">Closed</button>
        </div>
      </div>
    </div>
    <div id="journalList" style="max-height:400px;overflow-y:auto"></div>
  </div>

  <!-- Analysis Timeline -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Analysis Timeline</div>
      <span class="section-badge" id="tlBadge">-</span>
    </div>
    <div class="timeline" id="timeline">
      <div class="tl-empty">Waiting for first analysis...</div>
    </div>
  </div>

  <!-- Daily Reports -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Daily Reports</div>
      <span class="section-badge" id="reportsBadge">-</span>
    </div>
    <div class="timeline" id="reportsList">
      <div class="tl-empty">No reports yet</div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-section">
    <div class="chart-header">
      <div class="chart-title" id="chartLabel">Account Value</div>
      <div class="chart-tabs">
        <div class="chart-toggle-group" id="chartSourceTabs">
          <button class="chart-tab active" data-source="pnl">PnL</button>
          <button class="chart-tab" data-source="balance">Balance</button>
        </div>
        <div class="chart-toggle-group" id="chartPeriodTabs">
          <button class="chart-tab" data-period="day">1D</button>
          <button class="chart-tab" data-period="week">1W</button>
          <button class="chart-tab active" data-period="month">1M</button>
          <button class="chart-tab" data-period="allTime">All</button>
        </div>
      </div>
    </div>
    <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal-overlay" id="shareModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Share Dashboard</span>
      <button class="modal-close" onclick="closeShare()">&times;</button>
    </div>
    <div class="modal-body">
      <img class="modal-preview" id="sharePreview" alt="Dashboard screenshot">
      <div class="modal-actions">
        <button class="btn" onclick="downloadImage()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download
        </button>
        <button class="btn btn-primary" onclick="shareToX()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          Share to X
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
let mainChart = null;
let pieChart = null;
let chartSource = 'pnl';
let chartPeriod = 'month';
let pnlCache = [];
let portfolioCache = null; // { accountValue: [{ts,value}], pnl: [{ts,value}] }
let currentEquity = 0;
let shareDataUrl = '';

// ‚îÄ‚îÄ Sprite Animator ‚îÄ‚îÄ
const SPRITE_SHEET = 'data:image/png;base64,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';

const ANIM = { idle: 0, working: 1, sleeping: 2, celebrating: 3, worried: 4, warmup: 5 };
const FRAME_W = 64, FRAME_H = 64, COLS = 6, FPS = 8;

class SpriteAnimator {
  constructor(canvasId) {
    this.canvas = document.getElementById(canvasId);
    this.ctx = this.canvas.getContext('2d');
    this.img = new Image();
    this.loaded = false;
    this.row = ANIM.warmup;
    this.col = 0;
    this.tintColor = null;
    this.lastFrame = 0;
    this.running = true;

    this.img.onload = () => { this.loaded = true; this.draw(); };
    this.img.src = SPRITE_SHEET;

    // Offscreen canvas for tinting
    this.offCanvas = document.createElement('canvas');
    this.offCanvas.width = FRAME_W;
    this.offCanvas.height = FRAME_H;
    this.offCtx = this.offCanvas.getContext('2d');

    // Pause when tab hidden
    document.addEventListener('visibilitychange', () => {
      this.running = !document.hidden;
      if (this.running) this.loop(performance.now());
    });

    this.loop = this.loop.bind(this);
    requestAnimationFrame(this.loop);
  }

  setAnimation(row) {
    if (this.row !== row) { this.row = row; this.col = 0; }
  }

  setTint(color) { this.tintColor = color; }

  loop(ts) {
    if (!this.running) return;
    if (ts - this.lastFrame >= 1000 / FPS) {
      this.lastFrame = ts;
      this.col = (this.col + 1) % COLS;
      this.draw();
    }
    requestAnimationFrame(this.loop);
  }

  draw() {
    if (!this.loaded) return;
    const sx = this.col * FRAME_W, sy = this.row * FRAME_H;

    // Draw sprite to offscreen canvas
    this.offCtx.clearRect(0, 0, FRAME_W, FRAME_H);
    this.offCtx.drawImage(this.img, sx, sy, FRAME_W, FRAME_H, 0, 0, FRAME_W, FRAME_H);

    // Apply tint (color overlay on opaque pixels)
    if (this.tintColor) {
      this.offCtx.save();
      this.offCtx.globalCompositeOperation = 'source-atop';
      this.offCtx.fillStyle = this.tintColor;
      this.offCtx.globalAlpha = 0.12;
      this.offCtx.fillRect(0, 0, FRAME_W, FRAME_H);
      this.offCtx.restore();
    }

    // Copy to main canvas
    this.ctx.clearRect(0, 0, FRAME_W, FRAME_H);
    this.ctx.drawImage(this.offCanvas, 0, 0);
  }

  // For html2canvas screenshot: return current frame as img element
  toImage() {
    const img = document.createElement('img');
    img.width = 128; img.height = 128;
    img.style.imageRendering = 'pixelated';
    img.src = this.canvas.toDataURL('image/png');
    return img;
  }
}

let animator = null;

function fmtUsd(v) {
  const n = Number(v);
  if (isNaN(n)) return '-';
  return (n >= 0 ? '+' : '-') + '$' + Math.abs(n).toFixed(2);
}
function fmtUsdPlain(v) {
  const n = Number(v);
  return isNaN(n) ? '-' : '$' + n.toFixed(2);
}
function pnlColor(v) { return Number(v) >= 0 ? 'green' : 'red'; }
function fmtTime(ts) {
  const d = new Date(ts);
  return String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
}
function fmtDuration(ms) {
  const m = Math.floor(ms/60000), h = Math.floor(m/60), d = Math.floor(h/24);
  if (d > 0) return d + 'd ' + (h%24) + 'h';
  if (h > 0) return h + 'h ' + (m%60) + 'm';
  return m + 'm';
}
function timeAgo(ts) {
  if (!ts) return '';
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'min ago';
  return Math.floor(diff/3600000) + 'h ago';
}
async function fetchJson(url) {
  try { const r = await fetch(url); return r.ok ? await r.json() : null; } catch { return null; }
}

// ‚îÄ‚îÄ Chart ‚îÄ‚îÄ
function initChart() {
  mainChart = new Chart($('mainChart').getContext('2d'), {
    type: 'bar',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: {
        backgroundColor: '#1e2d4a', titleColor: '#e8edf5', bodyColor: '#e8edf5',
        borderColor: '#2a3f66', borderWidth: 1, padding: 10, cornerRadius: 8,
        callbacks: { label: c => (c.parsed.y >= 0 ? '+$' : '-$') + Math.abs(c.parsed.y).toFixed(2) }
      }},
      scales: {
        x: { ticks: { color: '#4a5a75', maxTicksLimit: 10, font: { size: 10 } }, grid: { color: 'rgba(28,42,66,0.5)' } },
        y: { ticks: { color: '#4a5a75', font: { size: 10 }, callback: v => '$' + v.toFixed(0) }, grid: { color: 'rgba(28,42,66,0.5)' } },
      },
    }
  });
}

function fmtChartTime(ts) {
  const d = new Date(ts);
  return String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
}

function updateChart() {
  if (!mainChart) return;

  // Use portfolio API data (primary) or fall back to fills-based pnlCache
  if (portfolioCache && portfolioCache.pnl.length > 0) {
    updateChartFromPortfolio();
  } else if (pnlCache.length > 0) {
    updateChartFromFills();
  }
}

function updateChartFromPortfolio() {
  const periodLabels = { day: '24H', week: '7D', month: '30D', allTime: 'All Time' };
  const periodLabel = periodLabels[portfolioCache.period] || '';

  if (chartSource === 'pnl') {
    const pnlData = portfolioCache.pnl;
    const labels = pnlData.map(d => fmtChartTime(d.ts));
    mainChart.config.type = 'line';
    mainChart.data = { labels, datasets: [{
      data: pnlData.map(d => d.value),
      borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.06)',
      fill: true, tension: 0.35, pointRadius: 1, pointHoverRadius: 4, borderWidth: 2,
    }]};
    $('chartLabel').textContent = 'PnL (' + periodLabel + ')';
  } else {
    const balData = portfolioCache.accountValue;
    const labels = balData.map(d => fmtChartTime(d.ts));
    mainChart.config.type = 'line';
    mainChart.data = { labels, datasets: [{
      data: balData.map(d => d.value),
      borderColor: '#14b8a6', backgroundColor: 'rgba(20,184,166,0.06)',
      fill: true, tension: 0.35, pointRadius: 1, pointHoverRadius: 4, borderWidth: 2,
    }]};
    $('chartLabel').textContent = 'Account Value (' + periodLabel + ')';
  }
  mainChart.update('none');
}

function updateChartFromFills() {
  // Fallback: only used when portfolio API is unavailable
  const labels = pnlCache.map(d => d.date.slice(5));
  mainChart.config.type = 'line';
  mainChart.data = { labels, datasets: [{
    data: pnlCache.map(d => d.cumulative),
    borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.06)',
    fill: true, tension: 0.35, pointRadius: 2, pointHoverRadius: 5, borderWidth: 2,
  }]};
  $('chartLabel').textContent = 'Cumulative PnL (fills)';
  mainChart.update('none');
}

// Chart toggle: source tabs (PnL / Balance)
document.querySelectorAll('#chartSourceTabs .chart-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('#chartSourceTabs .chart-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    chartSource = tab.dataset.source;
    updateChart();
  });
});

// Chart toggle: period tabs (1D / 1W / 1M / All)
document.querySelectorAll('#chartPeriodTabs .chart-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('#chartPeriodTabs .chart-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    chartPeriod = tab.dataset.period;
    // Fetch new period data
    fetchJson('/api/portfolio?period=' + chartPeriod).then(data => {
      if (data && data.pnl) { portfolioCache = data; updateChart(); }
    });
  });
});

// ‚îÄ‚îÄ Pie Chart ‚îÄ‚îÄ
const PIE_COLORS = ['#3b82f6', '#a78bfa', '#14b8a6', '#fb7185', '#f59e0b', '#10b981', '#ef4444'];

function initPieChart() {
  pieChart = new Chart($('pieChart').getContext('2d'), {
    type: 'doughnut',
    data: { labels: ['Cash'], datasets: [{ data: [100], backgroundColor: ['#1c2a42'] }] },
    options: {
      responsive: true, maintainAspectRatio: true,
      cutout: '60%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1e2d4a', titleColor: '#e8edf5', bodyColor: '#e8edf5',
          borderColor: '#2a3f66', borderWidth: 1, padding: 8, cornerRadius: 6,
          callbacks: { label: c => c.label + ': ' + c.parsed.toFixed(1) + '% ($' + (c.parsed * (currentEquity || 0) / 100).toFixed(2) + ')' }
        },
      },
    }
  });
}

function updatePieChart(positions, equity) {
  if (!pieChart) return;
  const eq = equity || 0;
  if (eq <= 0 || !positions || positions.length === 0) {
    pieChart.data = { labels: ['Cash'], datasets: [{ data: [100], backgroundColor: ['#1c2a42'] }] };
    pieChart.update('none');
    return;
  }

  const posData = positions.map((p, i) => {
    const notional = Math.abs(Number(p.size) * Number(p.markPrice));
    const leverage = Number(p.leverage) || 1;
    const margin = notional / leverage;
    const symbol = p.symbol.includes('-PERP') ? p.symbol : p.symbol + '-PERP';
    return { label: symbol, value: margin, color: PIE_COLORS[i % PIE_COLORS.length] };
  });

  const totalMargin = posData.reduce((s, d) => s + d.value, 0);
  const cashPct = Math.max(0, ((eq - totalMargin) / eq) * 100);
  const labels = posData.map(d => d.label).concat('Cash');
  const data = posData.map(d => (d.value / eq) * 100).concat(cashPct);
  const colors = posData.map(d => d.color).concat('#1c2a42');

  pieChart.data = { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] };
  pieChart.update('none');
}

// ‚îÄ‚îÄ Render: Agent ‚îÄ‚îÄ
function renderAgent(status) {
  if (!animator) return;

  // Tint colors by market direction
  const tintColors = { bullish: 'rgba(16,185,129,0.5)', bearish: 'rgba(251,113,133,0.5)', neutral: 'rgba(59,130,246,0.5)' };

  // API unavailable ‚Äî show sleeping bot
  if (!status || !status.brain) {
    $('liveDot').className = 'live-dot' + (status?.running ? '' : ' off');
    if (status) $('uptime').textContent = status.running ? 'up ' + fmtDuration(status.uptime) : 'stopped';

    if (!status) {
      animator.setAnimation(ANIM.sleeping);
      animator.setTint(null);
      $('agentStatus').textContent = 'Connecting...';
      $('regimeBadge').className = 'regime-badge warming';
      $('regimeBadge').textContent = 'offline';
      $('agentAction').textContent = 'Waiting for engine to start...';
    }
    return;
  }

  $('liveDot').className = 'live-dot' + (status.running ? '' : ' off');
  $('uptime').textContent = status.running ? 'up ' + fmtDuration(status.uptime) : 'stopped';

  const b = status.brain;
  const firstAnalysisDone = b.updatedAt > 0;
  const isRecent = firstAnalysisDone && (Date.now() - b.updatedAt < 300000);

  // Character state machine
  if (!firstAnalysisDone) {
    animator.setAnimation(ANIM.warmup);
    animator.setTint(null);
  } else if (isRecent) {
    if (b.regime === 'volatile' || b.direction === 'bearish') {
      animator.setAnimation(ANIM.worried);
      animator.setTint(tintColors.bearish);
    } else {
      animator.setAnimation(ANIM.working);
      animator.setTint(tintColors[b.direction] || tintColors.neutral);
    }
  } else {
    if (b.direction === 'bullish' && (b.regime === 'trending_up')) {
      animator.setAnimation(ANIM.celebrating);
      animator.setTint(tintColors.bullish);
    } else {
      animator.setAnimation(ANIM.idle);
      animator.setTint(tintColors[b.direction] || null);
    }
  }

  // Status text ‚Äî friendly names
  if (!firstAnalysisDone) {
    $('agentStatus').textContent = 'Warming Up';
    const badge = $('regimeBadge');
    badge.className = 'regime-badge warming';
    badge.textContent = 'starting';
    $('agentAction').textContent = 'Running first market analysis... this takes about 30 seconds.';
  } else {
    const regimeNames = { trending_up: 'Trending Up', trending_down: 'Trending Down', range: 'Ranging', volatile: 'High Volatility', unknown: 'Scanning' };
    $('agentStatus').textContent = regimeNames[b.regime] || b.regime;

    const badge = $('regimeBadge');
    const dirClass = b.direction === 'bullish' ? 'bullish' : b.direction === 'bearish' ? 'bearish' : b.regime === 'volatile' ? 'volatile' : 'neutral';
    badge.className = 'regime-badge ' + dirClass;
    badge.textContent = b.direction;

    const actionTexts = {
      trending_up: 'Riding the trend, scanning for momentum entries...',
      trending_down: 'Bearish conditions, watching for short opportunities...',
      range: 'Sideways market, waiting for breakout signals...',
      volatile: 'High volatility detected, tightening risk parameters...',
      unknown: 'Gathering market data...',
    };
    const ago = timeAgo(b.updatedAt);
    const reason = b.reasoning && b.reasoning !== 'Initializing...' ? b.reasoning : actionTexts[b.regime] || 'Monitoring markets...';
    $('agentAction').textContent = reason.slice(0, 120) + (ago ? ' (' + ago + ')' : '');
  }

  // Meta
  $('metaDir').textContent = b.direction || '-';
  $('metaConf').textContent = b.confidence ? b.confidence + '%' : '-';
  $('metaRisk').textContent = b.riskLevel ? Array(b.riskLevel).fill('‚óè').join('') + Array(5 - b.riskLevel).fill('‚óã').join('') : '-';
  if (status.llm) {
    $('metaLlm').textContent = status.llm.callsToday + ' calls ($' + status.llm.estimatedCostUsd.toFixed(3) + ')';
  }
}

function renderMetrics(equity, balance, fills, stats) {
  if (equity) {
    currentEquity = equity.equity;
    $('mBalance').textContent = fmtUsdPlain(equity.equity);
    $('mBalanceSub').textContent = '';
    const upnl = Number(equity.unrealizedPnl);
    const upnlEl = $('mUpnl');
    upnlEl.textContent = fmtUsd(upnl);
    upnlEl.className = 'metric-value ' + pnlColor(upnl);
    $('mUpnlSub').textContent = '';
  }
  if (balance) {
    $('mMargin').textContent = fmtUsdPlain(balance.marginUsed);
    $('mMarginSub').textContent = 'free: ' + fmtUsdPlain(balance.freeMargin);
  }
  if (fills && fills.length > 0) {
    const realized = fills.reduce((s, f) => s + parseFloat(f.closedPnl), 0);
    const rpnlEl = $('mRpnl');
    rpnlEl.textContent = fmtUsd(realized);
    rpnlEl.className = 'metric-value ' + pnlColor(realized);
    $('mRpnlSub').textContent = fills.length + ' trades';
  } else if (stats) {
    const rpnlEl = $('mRpnl');
    rpnlEl.textContent = fmtUsd(stats.totalPnl);
    rpnlEl.className = 'metric-value ' + pnlColor(stats.totalPnl);
    $('mRpnlSub').textContent = stats.wins + 'W / ' + stats.losses + 'L (' + stats.winRate + '%)';
  }
}

function renderPositions(positions, equity) {
  const wrap = $('positions');
  if (!positions || positions.length === 0) {
    wrap.innerHTML = '<div class="pos-empty">No open positions</div>';
    $('posBadge').textContent = '0';
    updatePieChart(null, 0);
    return;
  }
  $('posBadge').textContent = positions.length + ' open';
  wrap.innerHTML = positions.map(p => {
    const pnl = Number(p.unrealizedPnl);
    const sym = p.symbol.includes('-PERP') ? p.symbol : p.symbol + '-PERP';
    return `<div class="pos-card">
      <div class="pos-left">
        <div><span class="pos-symbol">${sym}</span> <span class="pos-side ${p.side}">${p.side.toUpperCase()}</span></div>
        <div class="pos-details">${Number(p.size).toFixed(4)} @ ${fmtUsdPlain(p.entryPrice)} | ${p.leverage}x</div>
      </div>
      <div class="pos-right">
        <div class="pos-pnl ${pnlColor(pnl)}">${fmtUsd(pnl)}</div>
        <div class="pos-meta">Mark: ${fmtUsdPlain(p.markPrice)}</div>
      </div>
    </div>`;
  }).join('');
  updatePieChart(positions, equity);
}

function renderTimeline(decisions) {
  const wrap = $('timeline');
  if (!decisions || decisions.length === 0) {
    wrap.innerHTML = '<div class="tl-empty">Waiting for first analysis...</div>';
    $('tlBadge').textContent = '';
    return;
  }
  $('tlBadge').textContent = decisions.length + ' entries';
  wrap.innerHTML = decisions.map(d => {
    const isUrgent = d.type === 'urgent_trigger';
    const isScalp = d.type === 'scalp_trigger';
    const typeClass = isUrgent || isScalp ? 'urgent' : 'comprehensive';
    const typeLabel = isScalp ? 'Scalp Trigger' : isUrgent ? 'Urgent Trigger' : 'Comprehensive';
    const hasTrade = d.had_trade === 1;
    let meta = '';
    if (d.regime) meta += `<span class="tl-meta-tag">${d.regime}</span>`;
    if (d.direction) meta += `<span class="tl-meta-tag">${d.direction}</span>`;
    if (d.confidence) meta += `<span class="tl-meta-tag">${d.confidence}%</span>`;
    if ((isUrgent || isScalp) && d.trigger_symbol) meta += `<span class="tl-meta-tag">${d.trigger_symbol} (score ${d.trigger_score})</span>`;
    let trade = '';
    if (hasTrade && d.trade_symbol) {
      const cls = d.trade_side === 'sell' ? 'sell' : 'buy';
      trade = `<div class="tl-trade ${cls}">${d.trade_side?.toUpperCase()} ${d.trade_symbol}</div>`;
    }
    return `<div class="tl-item" onclick="this.classList.toggle('expanded')">
      <div class="tl-dot ${typeClass}"></div><div class="tl-line"></div>
      <div class="tl-header">
        <span class="tl-type ${typeClass}">${typeLabel}</span>
        <span class="tl-time">${fmtTime(d.timestamp)}</span>
      </div>
      <div class="tl-meta">${meta}</div>
      <div class="tl-reasoning">${d.reasoning || 'No reasoning recorded'}</div>
      ${trade}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Share ‚îÄ‚îÄ
async function openShare() {
  const wm = $('shareWatermark');
  wm.style.display = 'block';

  // html2canvas can't capture <canvas> well ‚Äî swap to static <img> temporarily
  const charEl = $('pixelChar');
  const charCanvas = $('charCanvas');
  let tempImg = null;
  if (animator) {
    tempImg = animator.toImage();
    charCanvas.style.display = 'none';
    charEl.appendChild(tempImg);
  }

  try {
    const canvas = await html2canvas($('shareCard'), { backgroundColor: '#06090f', scale: 2, useCORS: true, logging: false });
    shareDataUrl = canvas.toDataURL('image/png');
    $('sharePreview').src = shareDataUrl;
    $('shareModal').classList.add('show');
  } catch (err) { console.error(err); alert('Screenshot failed'); }
  finally {
    wm.style.display = 'none';
    // Restore canvas
    if (tempImg) { charEl.removeChild(tempImg); charCanvas.style.display = ''; }
  }
}
function closeShare() { $('shareModal').classList.remove('show'); }
function downloadImage() {
  if (!shareDataUrl) return;
  const a = document.createElement('a');
  a.href = shareDataUrl;
  a.download = 'pangjibot-' + new Date().toISOString().slice(0,10) + '.png';
  a.click();
}
async function shareToX() {
  if (navigator.share && navigator.canShare) {
    try {
      const blob = await fetch(shareDataUrl).then(r => r.blob());
      const file = new File([blob], 'pangjibot.png', { type: 'image/png' });
      if (navigator.canShare({ files: [file] })) { await navigator.share({ text: 'My AI trading bot performance', files: [file] }); closeShare(); return; }
    } catch {}
  }
  downloadImage();
  window.open('https://x.com/intent/post?text=' + encodeURIComponent('My AI trading bot performance #pangjibot #CryptoTrading'), '_blank');
  closeShare();
}
$('shareModal').addEventListener('click', e => { if (e.target === $('shareModal')) closeShare(); });

// ‚îÄ‚îÄ Reports ‚îÄ‚îÄ
function renderReports(reports) {
  const wrap = $('reportsList');
  const badge = $('reportsBadge');
  if (!reports || reports.length === 0) {
    wrap.innerHTML = '<div class="tl-empty">No reports yet</div>';
    badge.textContent = '0';
    return;
  }
  badge.textContent = reports.length;
  wrap.innerHTML = reports.map(r => {
    const icon = r.report_type === 'morning' ? '‚òÄÔ∏è' : 'üåô';
    const label = r.report_type === 'morning' ? 'Morning' : 'Evening';
    const date = new Date(r.generated_at).toLocaleDateString('en-CA');
    const time = r.report_type === 'morning' ? '06:00' : '18:00';
    const sent = r.telegram_sent ? '‚úÖ' : '‚è≥';
    return `<div class="tl-item" onclick="toggleReport(this, ${r.id})">
      <div class="tl-dot" style="background:var(--accent)"></div>
      <div class="tl-line"></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="tl-type">${icon} ${label} Report</span>
        <span class="tl-time">${date} ${time} KST ${sent}</span>
      </div>
      <div class="tl-reasoning report-detail" style="display:none"></div>
    </div>`;
  }).join('');
}
async function toggleReport(el, id) {
  const detail = el.querySelector('.report-detail');
  if (el.classList.contains('expanded')) {
    el.classList.remove('expanded');
    detail.style.display = 'none';
    return;
  }
  if (!detail.dataset.loaded) {
    detail.textContent = 'Loading...';
    detail.style.display = 'block';
    try {
      const data = await fetchJson('/api/reports/' + id);
      if (data && data.telegram_message) {
        detail.innerHTML = data.telegram_message.replace(/\n/g, '<br>');
      } else {
        detail.textContent = 'No report content.';
      }
      detail.dataset.loaded = '1';
    } catch { detail.textContent = 'Failed to load report.'; }
  } else {
    detail.style.display = 'block';
  }
  el.classList.add('expanded');
}

// ‚îÄ‚îÄ Trade Journal ‚îÄ‚îÄ
let journalStatus = 'all';

document.querySelectorAll('#journalStatusTabs .chart-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('#journalStatusTabs .chart-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    journalStatus = tab.dataset.status;
    refreshJournal();
  });
});

async function refreshJournal() {
  const entries = await fetchJson('/api/journal?status=' + journalStatus + '&limit=50');
  renderJournal(entries);
}

function renderJournal(entries) {
  const wrap = $('journalList');
  if (!entries || entries.length === 0) {
    wrap.innerHTML = '<div class="tl-empty">No trades recorded yet...</div>';
    $('journalBadge').textContent = '';
    return;
  }

  $('journalBadge').textContent = entries.length + ' trades';

  wrap.innerHTML = entries.map(e => {
    const isOpen = e.status === 'open';
    const isWin = !isOpen && e.pnl > 0;
    const cardClass = isOpen ? 'open' : (isWin ? 'win' : 'loss');
    const icon = isOpen ? '\u{1F535}' : (isWin ? '\u2705' : '\u274C');
    const sideIcon = e.side === 'buy' ? '\u{1F7E2}' : '\u{1F534}';
    const stratLabel = e.strategy_id === 'scalp' ? 'SCALP' : (e.strategy_id === 'discretionary' ? 'DISC' : e.strategy_id.toUpperCase());
    const time = new Date(e.opened_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

    let priceInfo = '';
    if (isOpen) {
      priceInfo = 'Entry: $' + e.entry_price.toFixed(2) + ' | SL: $' + (e.stop_loss || 0).toFixed(2) + ' | TP: $' + (e.take_profit || 0).toFixed(2);
    } else {
      const pnlStr = e.pnl >= 0 ? '+$' + e.pnl.toFixed(2) : '-$' + Math.abs(e.pnl).toFixed(2);
      const pnlPct = e.pnl_pct != null ? ' (' + (e.pnl_pct >= 0 ? '+' : '') + e.pnl_pct.toFixed(2) + '%)' : '';
      const heldStr = e.held_minutes != null ? ' | ' + (e.held_minutes < 60 ? e.held_minutes + 'min' : Math.floor(e.held_minutes/60) + 'h' + (e.held_minutes%60) + 'm') : '';
      priceInfo = '$' + e.entry_price.toFixed(2) + ' \u2192 $' + (e.close_price || 0).toFixed(2) + ' | <span class="journal-pnl ' + (e.pnl >= 0 ? 'pos' : 'neg') + '">' + pnlStr + pnlPct + '</span>' + heldStr;
    }

    const rationale = e.entry_rationale ? '<div class="journal-rationale">\u{1F4DD} ' + e.entry_rationale.substring(0, 120) + (e.entry_rationale.length > 120 ? '...' : '') + '</div>' : '';
    const lesson = (!isOpen && e.review_lesson) ? '<div class="journal-rationale">\u{1F4A1} ' + e.review_lesson.substring(0, 100) + '</div>' : '';
    const reason = (!isOpen && e.close_reason) ? ' [' + e.close_reason + ']' : '';

    return '<div class="journal-card ' + cardClass + '">' +
      '<div class="journal-header">' +
        '<span class="journal-symbol">' + icon + ' ' + sideIcon + ' ' + e.symbol + ' ' + e.side.toUpperCase() + ' ' + e.leverage + 'x</span>' +
        '<span><span class="journal-strategy">' + stratLabel + '</span> <span style="font-size:11px;color:var(--text2)">' + time + '</span></span>' +
      '</div>' +
      '<div class="journal-detail">' + priceInfo + reason + '</div>' +
      rationale + lesson +
    '</div>';
  }).join('');
}

// ‚îÄ‚îÄ Position Candlestick Charts ‚îÄ‚îÄ
let candleInterval = '1h';
let posChartInstances = {}; // symbol -> { chart, candleSeries, card }
let lastPositions = null;

document.querySelectorAll('#candleIntervalTabs .chart-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('#candleIntervalTabs .chart-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    candleInterval = tab.dataset.interval;
    // Clear existing charts and re-render with new interval
    Object.values(posChartInstances).forEach(inst => inst.chart.remove());
    posChartInstances = {};
    $('posCharts').innerHTML = '';
    refreshPositionCharts(lastPositions);
  });
});

async function refreshPositionCharts(positions) {
  const section = $('posChartsSection');
  const container = $('posCharts');

  if (!positions || positions.length === 0) {
    section.style.display = 'none';
    Object.values(posChartInstances).forEach(inst => inst.chart.remove());
    posChartInstances = {};
    container.innerHTML = '';
    return;
  }

  section.style.display = '';
  const currentSymbols = new Set(positions.map(p => p.symbol.includes('-PERP') ? p.symbol : p.symbol + '-PERP'));

  // Remove charts for closed positions
  for (const sym of Object.keys(posChartInstances)) {
    if (!currentSymbols.has(sym)) {
      posChartInstances[sym].card.remove();
      posChartInstances[sym].chart.remove();
      delete posChartInstances[sym];
    }
  }

  for (const pos of positions) {
    const symbol = pos.symbol.includes('-PERP') ? pos.symbol : pos.symbol + '-PERP';
    await renderPositionChart(symbol, pos);
  }
}

async function renderPositionChart(symbol, pos) {
  const candles = await fetchJson('/api/candles?symbol=' + encodeURIComponent(symbol) + '&interval=' + candleInterval + '&limit=200');
  if (!candles || candles.length === 0) return;

  let inst = posChartInstances[symbol];

  if (!inst) {
    const container = $('posCharts');
    const card = document.createElement('div');
    card.className = 'pos-chart-card';
    card.innerHTML = '<div class="pos-chart-header">' +
      '<span class="pos-chart-symbol">' + symbol + ' <span class="pos-side ' + pos.side + '">' + pos.side.toUpperCase() + '</span></span>' +
      '<span class="pos-chart-price">Entry: ' + fmtUsdPlain(pos.entryPrice) + '</span>' +
      '</div>' +
      '<div class="pos-chart-container"></div>';
    container.appendChild(card);

    const chartContainer = card.querySelector('.pos-chart-container');
    const chart = LightweightCharts.createChart(chartContainer, {
      layout: { background: { color: '#0d1320' }, textColor: '#7a8ba8' },
      grid: { vertLines: { color: '#1c2a42' }, horzLines: { color: '#1c2a42' } },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#1c2a42' },
      timeScale: { borderColor: '#1c2a42', timeVisible: true },
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: '#10b981', downColor: '#ef4444',
      borderUpColor: '#10b981', borderDownColor: '#ef4444',
      wickUpColor: '#10b981', wickDownColor: '#ef4444',
    });

    inst = { chart, candleSeries, card };
    posChartInstances[symbol] = inst;

    new ResizeObserver(() => chart.applyOptions({ width: chartContainer.clientWidth }))
      .observe(chartContainer);
  }

  inst.candleSeries.setData(candles);

  // Remove old price lines and add entry line
  inst.candleSeries.createPriceLine({
    price: pos.entryPrice,
    color: '#3b82f6',
    lineWidth: 1,
    lineStyle: LightweightCharts.LineStyle.Dashed,
    axisLabelVisible: true,
    title: 'Entry',
  });

  inst.chart.timeScale().fitContent();
}

// ‚îÄ‚îÄ Main ‚îÄ‚îÄ
async function refresh() {
  const [status, equity, balance, portfolio, fills, positions, stats, decisions, reports] = await Promise.all([
    fetchJson('/api/status'), fetchJson('/api/equity'), fetchJson('/api/balance'),
    fetchJson('/api/portfolio?period=' + chartPeriod), fetchJson('/api/fills?limit=50'),
    fetchJson('/api/positions'), fetchJson('/api/stats'), fetchJson('/api/decisions?limit=500'),
    fetchJson('/api/reports?limit=10'),
  ]);
  renderAgent(status);
  renderMetrics(equity, balance, fills, stats);
  renderPositions(positions, equity?.equity);
  lastPositions = positions;
  refreshPositionCharts(positions);
  renderTimeline(decisions);
  refreshJournal();
  renderReports(reports);
  if (portfolio && portfolio.pnl) { portfolioCache = portfolio; updateChart(); }
}
animator = new SpriteAnimator('charCanvas');
initChart(); initPieChart(); refresh(); setInterval(refresh, 30000);
</script>
</body>
</html>
