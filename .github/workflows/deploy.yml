name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /home/tradebot/project/tradebot
            git fetch origin main
            git reset --hard origin/main
            npm install --production=false
            npm run build
            pm2 restart tradebot || pm2 start ecosystem.config.cjs

            # Telegram ë°°í¬ ì•Œë¦¼ (.envì—ì„œ í† í° ì½ê¸°)
            export $(grep -E '^TG_BOT_TOKEN=|^TG_CHAT_ID=' .env | xargs)
            DEPLOY_MSG="âœ… ë°°í¬ ì™„ë£Œ!%0A%0AğŸ“¦ Branch: main%0AğŸ• $(date '+%Y-%m-%d %H:%M:%S')%0AğŸ“ $(git log -1 --pretty=format:'%s')"
            curl -s "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TG_CHAT_ID}" \
              -d "text=${DEPLOY_MSG}" > /dev/null 2>&1 || true
